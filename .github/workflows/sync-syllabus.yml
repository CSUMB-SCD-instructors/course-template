name: Sync Syllabus to Syllabi Repository

on:
  push:
    branches: [main]
    paths:
      - 'syllabus.md'
      - 'syllabus-online.md'
      - 'calendar.md'
      - '.course-config'
      - '.course-config-online'

jobs:
  sync-syllabus:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout source repository
      uses: actions/checkout@v4
      
    - name: Check for sync token
      run: |
        if [ -z "${{ secrets.SYLLABI_SYNC_TOKEN }}" ]; then
          echo "::warning::SYLLABI_SYNC_TOKEN secret not found. To enable syllabus syncing:"
          echo "::warning::1. Go to repository Settings → Secrets and variables → Actions"
          echo "::warning::2. Add a new secret named SYLLABI_SYNC_TOKEN"
          echo "::warning::3. Set the value to a GitHub personal access token with write access to the [syllabi](https://github.com/CSUMB-SCD-instructors/syllabi)] repository"
          echo "::warning::4. The token needs 'repo' permissions for the syllabi repository"
          echo "Skipping sync due to missing token"
          exit 0
        fi
        
    - name: Checkout target repository
      if: env.SYLLABI_SYNC_TOKEN != ''
      uses: actions/checkout@v4
      with:
        repository: CSUMB-SCD-instructors/syllabi
        token: ${{ secrets.SYLLABI_SYNC_TOKEN }}
        path: syllabi-repo
      env:
        SYLLABI_SYNC_TOKEN: ${{ secrets.SYLLABI_SYNC_TOKEN }}
        
    - name: Copy course files
      if: env.SYLLABI_SYNC_TOKEN != ''
      env:
        SYLLABI_SYNC_TOKEN: ${{ secrets.SYLLABI_SYNC_TOKEN }}
      run: |
        # Load course configuration
        if [ -f .course-config ]; then
          source .course-config
        else
          echo "Error: .course-config file not found"
          exit 1
        fi

        # Validate course code is set
        if [ -z "$COURSE_CODE" ]; then
          echo "Error: COURSE_CODE not set in .course-config"
          exit 1
        fi

        # Check for default template values that shouldn't be used
        if [ "$COURSE_CODE" = "CSTXXX" ] ; then
          echo "Error: COURSE_CODE appears to be a template default value: '$COURSE_CODE'"
          echo "Please update .course-config with your actual course code before publishing"
          exit 1
        fi

        if [ -n "$COURSE_NAME" ] && ([ "$COURSE_NAME" = "Course Title" ] || [ "$COURSE_NAME" = "Your Course Name" ]); then
          echo "Error: COURSE_NAME appears to be a template default value: '$COURSE_NAME'"
          echo "Please update .course-config with your actual course name before publishing"
          exit 1
        fi

        # Ensure the _active directory exists
        mkdir -p "syllabi-repo/_active"

        # Determine calendar link for front matter
        calendar_link=""
        if [ -n "${CALENDAR_URL}" ]; then
          calendar_link="${CALENDAR_URL}"
        elif [ -f calendar.md ]; then
          calendar_link="/${COURSE_CODE}-calendar.html"
        fi

        # Copy syllabus to _active directory with proper Jekyll front matter
        echo "---" > "syllabi-repo/_active/${COURSE_CODE}-syllabus.md"
        echo "layout: default" >> "syllabi-repo/_active/${COURSE_CODE}-syllabus.md"
        echo "course_code: \"${COURSE_CODE}\"" >> "syllabi-repo/_active/${COURSE_CODE}-syllabus.md"
        echo "course_name: \"${COURSE_NAME}\"" >> "syllabi-repo/_active/${COURSE_CODE}-syllabus.md"
        echo "title: \"${COURSE_CODE} - ${COURSE_NAME}\"" >> "syllabi-repo/_active/${COURSE_CODE}-syllabus.md"
        if [ -n "$calendar_link" ]; then
          echo "course_calendar: \"${calendar_link}\"" >> "syllabi-repo/_active/${COURSE_CODE}-syllabus.md"
        fi
        echo "last_updated: $(date +%Y-%m-%d)" >> "syllabi-repo/_active/${COURSE_CODE}-syllabus.md"
        echo "---" >> "syllabi-repo/_active/${COURSE_CODE}-syllabus.md"
        echo "" >> "syllabi-repo/_active/${COURSE_CODE}-syllabus.md"

        # Copy syllabus content, updating internal links if needed
        sed "s/syllabus\.md/${COURSE_CODE}-syllabus.html/g; s/calendar\.md/${COURSE_CODE}-calendar.html/g" syllabus.md >> "syllabi-repo/_active/${COURSE_CODE}-syllabus.md"

        # Handle calendar - either from URL or local file
        if [ -f calendar.md ]; then
          # Copy calendar to _active directory with proper Jekyll front matter
          echo "---" > "syllabi-repo/_active/${COURSE_CODE}-calendar.md"
          echo "layout: default" >> "syllabi-repo/_active/${COURSE_CODE}-calendar.md"
          echo "course_code: \"${COURSE_CODE}\"" >> "syllabi-repo/_active/${COURSE_CODE}-calendar.md"
          echo "course_name: \"${COURSE_NAME}\"" >> "syllabi-repo/_active/${COURSE_CODE}-calendar.md"
          echo "title: \"${COURSE_CODE} Course Calendar\"" >> "syllabi-repo/_active/${COURSE_CODE}-calendar.md"
          echo "last_updated: $(date +%Y-%m-%d)" >> "syllabi-repo/_active/${COURSE_CODE}-calendar.md"
          echo "---" >> "syllabi-repo/_active/${COURSE_CODE}-calendar.md"
          echo "" >> "syllabi-repo/_active/${COURSE_CODE}-calendar.md"
          cat calendar.md >> "syllabi-repo/_active/${COURSE_CODE}-calendar.md"
          echo "Local calendar.md copied for ${COURSE_CODE}"
        fi

        echo "Syllabus and calendar copied to _active directory for ${COURSE_CODE}"

        # Check if online course configuration exists
        if [ -f .course-config-online ]; then
          echo "Found .course-config-online, processing online syllabus..."

          # Load online course configuration
          source .course-config-online

          # Use COURSE_CODE from online config, or append -online to main COURSE_CODE
          ONLINE_COURSE_CODE="${COURSE_CODE}-online"

          # Determine online calendar link
          online_calendar_link=""
          if [ -n "${CALENDAR_URL}" ]; then
            online_calendar_link="${CALENDAR_URL}"
          elif [ -f calendar.md ]; then
            online_calendar_link="/${ONLINE_COURSE_CODE}-calendar.html"
          fi

          # Copy online syllabus if it exists
          if [ -f syllabus-online.md ]; then
            echo "---" > "syllabi-repo/_active/${ONLINE_COURSE_CODE}-syllabus.md"
            echo "layout: default" >> "syllabi-repo/_active/${ONLINE_COURSE_CODE}-syllabus.md"
            echo "course_code: \"${ONLINE_COURSE_CODE}\"" >> "syllabi-repo/_active/${ONLINE_COURSE_CODE}-syllabus.md"
            echo "course_name: \"${COURSE_NAME}\"" >> "syllabi-repo/_active/${ONLINE_COURSE_CODE}-syllabus.md"
            echo "title: \"${ONLINE_COURSE_CODE} - ${COURSE_NAME}\"" >> "syllabi-repo/_active/${ONLINE_COURSE_CODE}-syllabus.md"
            if [ -n "$online_calendar_link" ]; then
              echo "course_calendar: \"${online_calendar_link}\"" >> "syllabi-repo/_active/${ONLINE_COURSE_CODE}-syllabus.md"
            fi
            echo "last_updated: $(date +%Y-%m-%d)" >> "syllabi-repo/_active/${ONLINE_COURSE_CODE}-syllabus.md"
            echo "---" >> "syllabi-repo/_active/${ONLINE_COURSE_CODE}-syllabus.md"
            echo "" >> "syllabi-repo/_active/${ONLINE_COURSE_CODE}-syllabus.md"

            # Copy online syllabus content
            sed "s/syllabus-online\.md/${ONLINE_COURSE_CODE}-syllabus.html/g; s/syllabus\.md/${ONLINE_COURSE_CODE}-syllabus.html/g; s/calendar\.md/${ONLINE_COURSE_CODE}-calendar.html/g" syllabus-online.md >> "syllabi-repo/_active/${ONLINE_COURSE_CODE}-syllabus.md"

            echo "Online syllabus copied for ${ONLINE_COURSE_CODE}"
          else
            echo "Warning: .course-config-online exists but syllabus-online.md not found"
          fi

          # Handle online calendar if using local file
          if [ -f calendar.md ]; then
            echo "---" > "syllabi-repo/_active/${ONLINE_COURSE_CODE}-calendar.md"
            echo "layout: default" >> "syllabi-repo/_active/${ONLINE_COURSE_CODE}-calendar.md"
            echo "course_code: \"${ONLINE_COURSE_CODE}\"" >> "syllabi-repo/_active/${ONLINE_COURSE_CODE}-calendar.md"
            echo "course_name: \"${COURSE_NAME}\"" >> "syllabi-repo/_active/${ONLINE_COURSE_CODE}-calendar.md"
            echo "title: \"${ONLINE_COURSE_CODE} Course Calendar\"" >> "syllabi-repo/_active/${ONLINE_COURSE_CODE}-calendar.md"
            echo "last_updated: $(date +%Y-%m-%d)" >> "syllabi-repo/_active/${ONLINE_COURSE_CODE}-calendar.md"
            echo "---" >> "syllabi-repo/_active/${ONLINE_COURSE_CODE}-calendar.md"
            echo "" >> "syllabi-repo/_active/${ONLINE_COURSE_CODE}-calendar.md"
            cat calendar.md >> "syllabi-repo/_active/${ONLINE_COURSE_CODE}-calendar.md"
            echo "Calendar copied for ${ONLINE_COURSE_CODE}"
          fi
        fi


    - name: Commit and push changes
      if: env.SYLLABI_SYNC_TOKEN != ''
      env:
        SYLLABI_SYNC_TOKEN: ${{ secrets.SYLLABI_SYNC_TOKEN }}
      run: |
        cd syllabi-repo
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Load course configuration
        source ../.course-config
        
        # Extract commit info
        COMMIT_SHA="${{ github.sha }}"
        SHORT_SHA="${COMMIT_SHA:0:7}"
        
        # Add files in _active directory
        git add "_active/${COURSE_CODE}-syllabus.md"
        if [ -f "_active/${COURSE_CODE}-calendar.md" ]; then
          git add "_active/${COURSE_CODE}-calendar.md"
        fi

        # Add online course files if they exist
        if [ -f "_active/${COURSE_CODE}-online-syllabus.md" ]; then
          git add "_active/${COURSE_CODE}-online-syllabus.md"
        fi
        if [ -f "_active/${COURSE_CODE}-online-calendar.md" ]; then
          git add "_active/${COURSE_CODE}-online-calendar.md"
        fi
        
        # Check if there are changes to commit
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Update ${COURSE_CODE} syllabus from ${SHORT_SHA}"
          git push
        fi